{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center text-white mb-5">
        <h1><i class="fas fa-user-cog"></i> Admin Dashboard</h1>
        <p class="lead">Manage members, contributions & view financial reports</p>
    </div>

    <!-- Top Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h5>Total Members</h5>
                <h2 id="totalMembers" class="count-up">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h5>This Month</h5>
                <h2 id="thisMonth" class="count-up">$0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h5>This Year</h5>
                <h2 id="thisYear" class="count-up">$0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h5>Total Collected</h5>
                <h2 id="totalCollected" class="count-up">$0</h2>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-4 justify-content-center" id="adminTabs">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#membersTab">Members</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#contributionsTab">Contributions</button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Members Tab -->
        <div class="tab-pane fade show active" id="membersTab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card p-4">
                        <h5><i class="fas fa-user-plus"></i> Add New Member</h5>
                        <form id="addMemberForm">
                            <input type="text" name="first_name" class="form-control mb-3" placeholder="First Name" required>
                            <input type="text" name="last_name" class="form-control mb-3" placeholder="Last Name" required>
                            <input type="tel" name="mobile_no" class="form-control mb-3" placeholder="Mobile Number" required>
                            <input type="password" name="password" class="form-control mb-3" placeholder="Password" required>
                            <input type="text" name="city" class="form-control mb-3" placeholder="City">
                            <input type="number" step="0.01" name="fixed_amount" class="form-control mb-3" placeholder="Fixed Amount">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i> Add Member</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card p-4">
                        <h5><i class="fas fa-list"></i> Members List</h5>
                        <input type="text" class="form-control mb-3" id="searchMembers" placeholder="Search members...">
                        <div id="membersList" class="list-group" style="max-height:400px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contributions Tab -->
        <div class="tab-pane fade" id="contributionsTab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card p-4">
                        <h5><i class="fas fa-money-bill"></i> Record Contribution</h5>
                        <form id="addContributionForm">
                            <select id="contributionMember" name="member_id" class="form-select mb-3" required>
                                <option value="">Select Member...</option>
                            </select>
                            <input type="number" name="amount" class="form-control mb-3" placeholder="Amount" step="0.01" required>
                            <input type="date" name="date" class="form-control mb-3" id="contributionDate" required>
                            <select name="payment_method" class="form-select mb-3" required>
                                <option value="cash">Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                            <input type="text" name="purpose" class="form-control mb-3" placeholder="Purpose" required>
                            <button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i> Record</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card p-4">
                        <h5><i class="fas fa-history"></i> Recent Contributions</h5>
                        <div id="contributionsList" style="max-height:400px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="messageContainer" class="position-fixed top-0 end-0 p-3" style="z-index:1050;"></div>
{% endblock %}

{% block scripts %}
<script>
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    loadMembers();
    loadMemberOptions();
    loadContributions();
    document.getElementById('contributionDate').value = new Date().toISOString().split('T')[0];
    
    // Member form submission
    document.getElementById('addMemberForm').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target));
        
        try {
            const response = await fetch('/api/members', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showMessage('Member added successfully!');
                e.target.reset();
                loadMembers();
                loadMemberOptions();
            } else {
                showMessage(data.detail || 'Error adding member', 'danger');
            }
        } catch (error) {
            showMessage('Network error occurred', 'danger');
        }
    });

    // Contribution form submission
    document.getElementById('addContributionForm').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target));
        
        try {
            const response = await fetch('/api/contributions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showMessage('Contribution recorded successfully!');
                e.target.reset();
                loadContributions();
            } else {
                showMessage(data.detail || 'Error recording contribution', 'danger');
            }
        } catch (error) {
            showMessage('Network error occurred', 'danger');
        }
    });
});

// Load members list
async function loadMembers() {
    try {
        const response = await fetch('/api/members');
        const members = await response.json();
        const membersList = document.getElementById('membersList');
        
        membersList.innerHTML = '';
        
        members.forEach(member => {
            const memberItem = document.createElement('div');
            memberItem.className = 'list-group-item list-group-item-action';
            memberItem.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${member.first_name} ${member.last_name}</strong>
                    <small>ID: ${member.member_id}</small>
                </div>
                <div><small>${member.mobile_no} | ${member.city || 'N/A'}</small></div>
                <div><small>Fixed: $${member.fixed_amount || 0}</small></div>
            `;
            membersList.appendChild(memberItem);
        });

        // Add search functionality
        document.getElementById('searchMembers').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const items = membersList.querySelectorAll('.list-group-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });
    } catch (error) {
        showMessage('Failed to load members', 'danger');
    }
}

// Load members for contribution dropdown
async function loadMemberOptions() {
    try {
        const response = await fetch('/api/members');
        const members = await response.json();
        const select = document.getElementById('contributionMember');
        
        // Clear existing options except the first one
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        members.forEach(member => {
            const option = document.createElement('option');
            option.value = member.member_id;
            option.textContent = `${member.first_name} ${member.last_name} (${member.mobile_no})`;
            select.appendChild(option);
        });
    } catch (error) {
        showMessage('Failed to load member options', 'danger');
    }
}

// Load contributions list
async function loadContributions() {
    try {
        const response = await fetch('/api/contributions');
        const contributions = await response.json();
        const contributionsList = document.getElementById('contributionsList');
        
        contributionsList.innerHTML = '';
        
        if (contributions.length === 0) {
            contributionsList.innerHTML = '<div class="text-center py-3">No contributions found</div>';
            return;
        }
        
        contributions.forEach(contribution => {
            const contributionItem = document.createElement('div');
            contributionItem.className = 'list-group-item';
            contributionItem.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>Member ID: ${contribution.member_id}</strong>
                    <span class="badge bg-primary">$${contribution.amount}</span>
                </div>
                <div class="text-muted small">
                    ${new Date(contribution.date).toLocaleDateString()} - 
                    ${contribution.payment_method} - 
                    ${contribution.purpose}
                </div>
                <div class="small">Recorded by: ${contribution.recorded_by}</div>
            `;
            contributionsList.appendChild(contributionItem);
        });
    } catch (error) {
        showMessage('Failed to load contributions', 'danger');
    }
}

// Show toast messages
function showMessage(message, type = 'success') {
    const container = document.getElementById('messageContainer');
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    container.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 150);
    }, 5000);
}
</script>
{% endblock %}  1